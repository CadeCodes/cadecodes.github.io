function getCookie(cname){var name=cname+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' ')c=c.substring(1);if(c.indexOf(name)==0)return c.substring(name.length,c.length);}
return "";}
var connection=null;function StartConnection(){console.log("Connecting..");connection.start().then(function(){var chatInput=$('#chatinputbox');var ticketId=chatInput.attr('ticket-id');connection.invoke('AuthorizeConnection',getCookie('ChillToken'),ticketId);console.log("Connected!");});}
$(document).ready(function(){const ps=new PerfectScrollbar('.chat-conversation-box',{suppressScrollX:true});const getScrollContainer=document.querySelector('.chat-conversation-box');getScrollContainer.scrollTop=getScrollContainer.scrollHeight;if(connection===null)
connection=new signalR.HubConnectionBuilder().withUrl('/supporthub').withAutomaticReconnect().build();StartConnection();connection.on('error',function(e){console.log("generic error");location.reload();});connection.on('message',function(msg){AddNewMessage(msg);});connection.on("spam",function(){console.log("spam");Snackbar.show({pos:'bottom-right',text:'You are sending too many messages',duration:5000,actionTextColor:'#fff',backgroundColor:'#e7515a'});});connection.onclose(function(e){console.log("on close");location.reload();});connection.onreconnected(error=>{console.log("On reconnected");Snackbar.show({pos:'bottom-right',text:'Reconnected!',duration:2000,actionTextColor:'#fff',backgroundColor:'#8dbf42'});});document.addEventListener("visibilitychange",function(){var visibility=document.visibilityState;if(visibility==='visible'&&connection.state!=signalR.HubConnectionState.Connected)
{console.log("return");location.reload();}});});function AddNewMessage(msg){var chatInput=$('#chatinputbox');var id=chatInput.attr('last-msg-id');if(msg.isSelf){$messageHtml='<div class="bubble-container-me" style="width: 100%;"><div class="bubble me"><div style="padding-bottom: 2px;"><span><b>'+
msg.from+'</b> <a style="color: red;"><b>'+msg.userTitle+'</b></a></span></div>'+msg.messageText;if(msg.timeAgo.length){$messageHtml=$messageHtml+'<br /><a class="deletebutton" msg-id="'+msg.id+'" href="" style="font-size: 11px; float: left; color: red; font-weight: bold; padding-top: 3px;">Delete</a><div style="font-size: 11px; float: right; color: gray; padding-top: 3px;">'+msg.timeAgo+'</div>';}
$messageHtml=$messageHtml+'</div></div>';var appendMessage=$('.chat-system').find('.active-chat').append($messageHtml);var deletebutton=appendMessage.find('.deletebutton');deletebutton.on('click',function(event){var deletebtn=$(this);var msgId=deletebtn.attr('msg-id');var chatInput=$('#chatinputbox');var ticketId=chatInput.attr('ticket-id');connection.invoke('Delete',msgId,ticketId);});}else{$messageHtml='<div class="bubble you"><div style="padding-bottom: 2px;"><span><b>'+
msg.from+'</b> <a style="color: red;"><b>'+msg.userTitle+'</b></a></span></div>'+msg.messageText;if(msg.timeAgo.length){$messageHtml=$messageHtml+'<br /><div style="font-size: 11px; float: right; color: gray; padding-top: 3px;">'+msg.timeAgo+'</div>';}
$messageHtml=$messageHtml+'</div>';var appendMessage=$('.chat-system').find('.active-chat').append($messageHtml);}
const getScrollContainer=document.querySelector('.chat-conversation-box');getScrollContainer.scrollTop=getScrollContainer.scrollHeight;}
$('.mail-write-box').on('keydown',function(event){if(event.key==='Enter'){var chatInput=$(this);var chatMessageValue=chatInput.val();var ticketId=chatInput.attr('ticket-id');if(chatMessageValue===''){return;}
if(connection!=null){connection.invoke('Send',chatMessageValue,ticketId);var clearChatInput=chatInput.val('');}}})
$('.hamburger, .chat-system .chat-box .chat-not-selected p').on('click',function(event){$(this).parents('.chat-system').find('.user-list-box').toggleClass('user-list-box-show')})
$('.deletebutton').on('click',function(event){var deletebtn=$(this);var msgId=deletebtn.attr('msg-id');var chatInput=$('#chatinputbox');var ticketId=chatInput.attr('ticket-id');connection.invoke('Delete',msgId,ticketId);});$('.ticketmodalsave').on('click',function(event){var options=$('#ticketoptions');var value=options.val();var options2=$('#tickettype');var value2=options2.val();var chatInput=$('#chatinputbox');var ticketId=chatInput.attr('ticket-id');var change={TicketId:ticketId,Value:value,TicketType:value2};$.ajax({url:'SubmitTicketUpdate',type:'POST',data:JSON.stringify(change),contentType:'application/json; charset=utf-8',dataType:'json',async:true,success:function(msg){if(msg.statusCode=="ok"){Snackbar.show({pos:'bottom-right',text:'Saved settings!',duration:5000,actionTextColor:'#fff',backgroundColor:'#8dbf42'});}}});$('#ticketsettings').modal('hide');});